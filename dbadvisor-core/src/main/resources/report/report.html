<!DOCTYPE html>
<html>
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    
    <!-- Highlighter -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

    <!-- RE:Dom -->
    <script src="//redom.js.org/redom.min.js"></script>
    <style>
        :root {
            --super-light-gray: #fafafa;
            --border-gray: #e9ecef;
        }

        .row-issue:hover {
            background-color: var(--super-light-gray);
            cursor: pointer;
        }

        section {
            margin: 10px;
            position: relative;
            text-align: left;
        }

        section h5 {
            padding-left: 10px;
        }

        .operation {
            position: relative;
            top: 6px;
            margin-right: 7px;
            float: left;
        }

        .code-overflow-expand {
            white-space: normal !important;
            overflow-x: hidden !important;
            overflow-y: auto;
        }

        .code-overflow {
            white-space: nowrap;
            overflow-x: hidden !important;
            text-overflow: ellipsis;
        }

        li {
            background-color: transparent !important;
        }

        .borderless {
            border: 0;
            padding-bottom: 0;
        }

        #menu {
            background-color: var(--super-light-gray);
            height: inherit;
            min-height: 92.5vh;
            border-right: 1px solid var(--border-gray);
        }

        #issues {
            margin-left: 1em;
            padding-right: 10px;
        }

        .row-issue {
            border-bottom: 1px solid var(--border-gray);
            padding-top: 10px;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="container-fluid">
        <nav class="navbar bg-primary">
            <a class="navbar-brand text-white" href="#">DB Advisor issue report</a>
        </nav>
        <div class="row">
            <div id="menu" class="col-2">
                <section>
                    <h5>Issue Type</h5>
                    <ul id='issueType' class='list-group'/>
                </section>
            </div>
            <div class="col-10">
                <div id="issues">
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    hljs.initHighlightingOnLoad();
    const { el, mount } = redom;

    let data = [{
        "type": "CPU Cost",
        "query": "select distinct question0_.id as id1_17_0_, responses1_.id as id1_19_1_, question0_.created_by as created_by2_17_0_, question0_.created_date as created_date3_17_0_, question0_.updated_by as updated_by4_17_0_, question0_.updated_date as updated_date5_17_0_, question0_.version as version6_17_0_, question0_.code as code7_17_0_, question0_.description as description8_17_0_, question0_.language as language9_17_0_, question0_.sort_order as sort_order10_17_0_, question0_.text as text11_17_0_, responses1_.created_by as created_by2_19_1_, responses1_.created_date as created_date3_19_1_, responses1_.updated_by as updated_by4_19_1_, responses1_.updated_date as updated_date5_19_1_, responses1_.version as version6_19_1_, responses1_.code as code7_19_1_, responses1_.default_flag as default_flag8_19_1_, responses1_.description as description9_19_1_, responses1_.max_value as max_value10_19_1_, responses1_.min_value as min_value11_19_1_, responses1_.question_code as question_code12_19_1_, responses1_.question_language as question_language13_19_1_, responses1_.sort_order as sort_order14_19_1_, responses1_.type as type15_19_1_, responses1_.question_code as question_code12_19_0__, responses1_.question_language as question_language13_19_0__, responses1_.id as id1_19_0__ from question question0_ left outer join question_response responses1_ on question0_.code=responses1_.question_code and question0_.language=responses1_.question_language where question0_.code in (select questionse2_.question_code from question_set_2_question questionse2_ where questionse2_.question_set_code=?) order by question0_.sort_order",
        "description": "CPU costs for query are over the limit",
        "weight": 78174335,
        "weightUnit": null,
        "timestamp": "2017-11-04T11:13:20.606",
        "stackTrace": ["java.util.ArrayList.forEach(ArrayList.java:1249)", "com.github.embeditcz.dbadvisor.core.internal.analyzer.oracle.ExplainPlanAnalyzer.analyzeImpl(ExplainPlanAnalyzer.java:47)", "com.github.embeditcz.dbadvisor.core.internal.analyzer.AbstractQueryAnalyzer.analyze(AbstractQueryAnalyzer.java:34)", "com.github.embeditcz.dbadvisor.core.internal.DbAdvisorQueryExecutionListener.analyzeQuery(DbAdvisorQueryExecutionListener.java:53)", "com.github.embeditcz.dbadvisor.core.internal.DbAdvisorQueryExecutionListener.afterQuery(DbAdvisorQueryExecutionListener.java:46)", "net.ttddyy.dsproxy.listener.ChainListener.afterQuery(ChainListener.java:27)", "net.ttddyy.dsproxy.proxy.PreparedStatementProxyLogic.performQueryExecutionListener(PreparedStatementProxyLogic.java:251)", "net.ttddyy.dsproxy.proxy.PreparedStatementProxyLogic.access$500(PreparedStatementProxyLogic.java:32)", "net.ttddyy.dsproxy.proxy.PreparedStatementProxyLogic$1.execute(PreparedStatementProxyLogic.java:104)", "net.ttddyy.dsproxy.listener.MethodExecutionListenerUtils.invoke(MethodExecutionListenerUtils.java:37)", "net.ttddyy.dsproxy.proxy.PreparedStatementProxyLogic.invoke(PreparedStatementProxyLogic.java:101)", "net.ttddyy.dsproxy.proxy.jdk.PreparedStatementInvocationHandler.invoke(PreparedStatementInvocationHandler.java:35)", "com.sun.proxy.$Proxy273.executeQuery(Unknown Source)", "org.hibernate.engine.jdbc.internal.ResultSetReturnImpl.extract(ResultSetReturnImpl.java:70)", "org.hibernate.loader.Loader.getResultSet(Loader.java:2117)", "org.hibernate.loader.Loader.executeQueryStatement(Loader.java:1900)", "org.hibernate.loader.Loader.executeQueryStatement(Loader.java:1876)", "org.hibernate.loader.Loader.doQuery(Loader.java:919)", "org.hibernate.loader.Loader.doQueryAndInitializeNonLazyCollections(Loader.java:336)", "org.hibernate.loader.Loader.doList(Loader.java:2617)"],
        "metadata": {
            "elapsedTime": 1
        }
    },{
        "type": "CPU Cost",
        "query": "select question0_.id as id1_17_0_, responses1_.id as id1_19_1_, question0_.created_by as created_by2_17_0_, question0_.created_date as created_date3_17_0_, question0_.updated_by as updated_by4_17_0_, question0_.updated_date as updated_date5_17_0_, question0_.version as version6_17_0_, question0_.code as code7_17_0_, question0_.description as description8_17_0_, question0_.language as language9_17_0_, question0_.sort_order as sort_order10_17_0_, question0_.text as text11_17_0_, responses1_.created_by as created_by2_19_1_, responses1_.created_date as created_date3_19_1_, responses1_.updated_by as updated_by4_19_1_, responses1_.updated_date as updated_date5_19_1_, responses1_.version as version6_19_1_, responses1_.code as code7_19_1_, responses1_.default_flag as default_flag8_19_1_, responses1_.description as description9_19_1_, responses1_.max_value as max_value10_19_1_, responses1_.min_value as min_value11_19_1_, responses1_.question_code as question_code12_19_1_, responses1_.question_language as question_language13_19_1_, responses1_.sort_order as sort_order14_19_1_, responses1_.type as type15_19_1_, responses1_.question_code as question_code12_19_0__, responses1_.question_language as question_language13_19_0__, responses1_.id as id1_19_0__ from question question0_ left outer join question_response responses1_ on question0_.code=responses1_.question_code and question0_.language=responses1_.question_language where question0_.code in (select questionse2_.question_code from question_set_2_question questionse2_ where questionse2_.question_set_code=?) order by question0_.sort_order",
        "description": "CPU costs for query are over the limit",
        "weight": 78174335,
        "weightUnit": null,
        "timestamp": "2017-11-04T11:13:20.606",
        "stackTrace": ["java.util.ArrayList.forEach(ArrayList.java:1249)", "com.github.embeditcz.dbadvisor.core.internal.analyzer.oracle.ExplainPlanAnalyzer.analyzeImpl(ExplainPlanAnalyzer.java:47)", "com.github.embeditcz.dbadvisor.core.internal.analyzer.AbstractQueryAnalyzer.analyze(AbstractQueryAnalyzer.java:34)", "com.github.embeditcz.dbadvisor.core.internal.DbAdvisorQueryExecutionListener.analyzeQuery(DbAdvisorQueryExecutionListener.java:53)", "com.github.embeditcz.dbadvisor.core.internal.DbAdvisorQueryExecutionListener.afterQuery(DbAdvisorQueryExecutionListener.java:46)", "net.ttddyy.dsproxy.listener.ChainListener.afterQuery(ChainListener.java:27)", "net.ttddyy.dsproxy.proxy.PreparedStatementProxyLogic.performQueryExecutionListener(PreparedStatementProxyLogic.java:251)", "net.ttddyy.dsproxy.proxy.PreparedStatementProxyLogic.access$500(PreparedStatementProxyLogic.java:32)", "net.ttddyy.dsproxy.proxy.PreparedStatementProxyLogic$1.execute(PreparedStatementProxyLogic.java:104)", "net.ttddyy.dsproxy.listener.MethodExecutionListenerUtils.invoke(MethodExecutionListenerUtils.java:37)", "net.ttddyy.dsproxy.proxy.PreparedStatementProxyLogic.invoke(PreparedStatementProxyLogic.java:101)", "net.ttddyy.dsproxy.proxy.jdk.PreparedStatementInvocationHandler.invoke(PreparedStatementInvocationHandler.java:35)", "com.sun.proxy.$Proxy273.executeQuery(Unknown Source)", "org.hibernate.engine.jdbc.internal.ResultSetReturnImpl.extract(ResultSetReturnImpl.java:70)", "org.hibernate.loader.Loader.getResultSet(Loader.java:2117)", "org.hibernate.loader.Loader.executeQueryStatement(Loader.java:1900)", "org.hibernate.loader.Loader.executeQueryStatement(Loader.java:1876)", "org.hibernate.loader.Loader.doQuery(Loader.java:919)", "org.hibernate.loader.Loader.doQueryAndInitializeNonLazyCollections(Loader.java:336)", "org.hibernate.loader.Loader.doList(Loader.java:2617)"],
        "metadata": {
            "elapsedTime": 1
        }
    }];

    let modes = new Set();

    data.forEach(function(value) {
        if (!modes.has(value.type)) {
            modes.add(value.type);
        }
    });

    data.forEach(function (value, index) {
        const issue = el('div.row.row-issue', [
            el('div.col-2',
                el('h6', value.type)),
            el('div.col-10', [
                el('p', value.description),
                el('pre',
                    el('code.sql.zenburn.code-overflow', value.query)),
                el('div.badge.badge-primary.float-right', value.weight + " " + (value.weightUnit ? value.weightUnit : "")),
                el('div.extra-data', { style: {display: "none"}}, 
                    el('div.stack-trace', [
                        el('label', 'Stack trace:'),
                        el('pre', value.stackTrace.join('\n'))
                    ]))
            ])
        ]);
        // show and hide details
        issue.onclick = e => {
            const extraData = e.currentTarget.getElementsByClassName("extra-data")[0];
            const code = e.currentTarget.getElementsByClassName("sql")[0];
            
            if (extraData.style.display === "none") {
                extraData.style.display = "";
                code.classList.remove("code-overflow");
            } else {
                extraData.style.display = "none";                
                code.classList.add("code-overflow");
            }
        }
        mount(document.getElementById('issues'), issue);
    });

    // generate issue type list
    modes.forEach( function(val) {
        const menu = document.getElementById('issueType');
        const checkbox = el('input.operation', {name: val, type: 'checkbox', checked: true});
        const item = el('li.list-group-item.borderless', 
            el('div.checkbox',
                el('label',
                    checkbox, val)));
        
        checkbox.onclick = e => {
            const selectedType = e.currentTarget.parentElement.textContent;
            const rows = document.getElementsByClassName("row-issue");
            for (var i = 0; i < rows.length; i++) {
                const type = rows[i].children[0].children[0].textContent;
                if (selectedType === type) {
                    rows[i].style.display = e.currentTarget.checked ? "" : "none";
                }
            }
        }

        mount(menu, item);
    });
</script>
</html>
